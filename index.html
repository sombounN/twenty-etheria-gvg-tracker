<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Etheria Restart – GW Counter Tracker</title>
    <style>
      :root{--bg:#f8fafc;--card:#ffffff;--muted:#64748b;--border:#e2e8f0;}
      body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#0f172a}
      .container{max-width:1120px;margin:0 auto;padding:24px}
      .row{display:flex;gap:8px;flex-wrap:wrap}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
      .card h2{margin:0 0 8px 0}
      .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}
      .btn.secondary{background:#f1f5f9}
      .input{padding:8px 10px;border-radius:10px;border:1px solid var(--border);width:100%}
      table{border-collapse:collapse;width:100%}
      th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
      .muted{color:var(--muted)}
      .grid{display:grid;gap:12px}
      @media(min-width:768px){.grid-cols-12{grid-template-columns:repeat(12,1fr)}}
      .col-2{grid-column:span 2}
      .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;margin-left:8px;font-size:12px;color:#475569}
    </style>
  </head>
  <body>
    <div id="root">Loading…</div>

    <!-- Load libraries first -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App code -->
    <script type="text/babel" data-presets="react">
      const {useState, useMemo, useEffect} = React;

      // CHANGE THIS TO YOUR GOOGLE WEB APP URL
      const GOOGLE_WEB_APP_URL = "https://gas-proxy-phi.vercel.app";

      const UNIT_LIST = [
        "Andrew","Asshu","Batsby","Beyontin","Borgne","Cachi","Cachi [The Guard]","Celince","Chiaki",
        "Chiaki [The Echo]","Dinah","Diting","DokiDoki","Dorothy","Dorothy [The Wisher]","Fangus","Freya","Fuqiu",
        "Gray","Heinrich","Helkid","Hizuki Mari","Holden","Hoyan","Kazami Kazuyo","Kazuyo [The Reverie]","Khloros",
        "Kloss","Kraken","Lian","Liliam","Lilith","Lily","Lingluo","Marvell","Massiah","Mia","Mio","Mizuki Makoto",
        "Nahor","Nell","Ninfoniel","No. 41","Obol","Oboro","Plume","RC-77","Rahu","Rilmocha","Rin","Rin [The Unbowed]",
        "Rosa","Sania","Sania [Vengeful Thorn]","Sybil","Tiamat","Tsukiyo Mi","Tsutomu","Turandot","Valerian","Veronika",
        "Vice","Victor","Viper","Xiada","Yang","Yeli"
      ];

      const norm = (names) => [...names].map(n=>n.trim()).filter(Boolean).sort((a,b)=> a.localeCompare(b));
      const trioKey = (t) => norm(t).join(" · ");

      function aggregate(rows){
        const byDef = new Map();
        for(const r of rows){
          const k = trioKey(r.defense);
          if(!byDef.has(k)) byDef.set(k, { defense: norm(r.defense), count:0, wins:0, offenses: new Map() });
          const d = byDef.get(k);
          d.count++; if(r.result==="Win") d.wins++;
          const ok = trioKey(r.offense);
          if(!d.offenses.has(ok)) d.offenses.set(ok, { offense: norm(r.offense), wins:0, total:0 });
          const o = d.offenses.get(ok);
          o.total++; if(r.result==="Win") o.wins++;
        }
        return byDef;
      }

      // Fetch all fight entries from Google Sheets
      function fetchSheetData(setRows){
        fetch(GOOGLE_WEB_APP_URL)
          .then(response => response.json())
          .then(data => {
            let rows = data;
            if (rows.length && rows[0][0].toLowerCase() === "id") rows = rows.slice(1);
            setRows(rows.map(r => ({
              id: r[0] || "",
              week: r[1] || "",
              defense: [r[2]||"", r[3]||"", r[4]||""],
              offense: [r[5]||"", r[6]||"", r[7]||""],
              result: r[8] || "",
              notes: r[9] || ""
            })));
          })
          .catch(err => {
            console.error("Error loading from Google Sheets:", err);
          });
      }

      // Add a fight entry to Google Sheets
      function addEntryToSheet(entry, setRows, setNewEntry){
        fetch(GOOGLE_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({
            id: entry.id,
            week: entry.week,
            def1: entry.defense[0],
            def2: entry.defense[1],
            def3: entry.defense[2],
            off1: entry.offense[0],
            off2: entry.offense[1],
            off3: entry.offense[2],
            result: entry.result,
            notes: entry.notes
          }),
          headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.text())
        .then(data => {
          alert(data); // Should say "Success"
          setNewEntry({ id: crypto.randomUUID(), week: "", defense:["","",""], offense:["","",""], result:"Win", notes:"" });
          fetchSheetData(setRows); // reload list after adding
        })
        .catch(err => {
          alert("Failed to add entry: " + err);
        });
      }

      function App(){
        const [rows, setRows] = useState([]);
        const [searchDefense, setSearchDefense] = useState("");
        const [includeUnit, setIncludeUnit] = useState("");
        const [excludeUnit, setExcludeUnit] = useState("");
        const [exactMatch, setExactMatch] = useState(false);
        const [selectedDefenseKey, setSelectedDefenseKey] = useState(null);

        useEffect(() => {
          fetchSheetData(setRows);
        }, []);

        const defenses = useMemo(()=> aggregate(rows), [rows]);
        const selectedDefense = useMemo(() => selectedDefenseKey ? defenses.get(selectedDefenseKey) : null, [defenses, selectedDefenseKey]);

        const filteredDefenses = useMemo(()=>{
          const items = Array.from(defenses.values());
          const s = searchDefense.trim();
          const inc = includeUnit.trim().toLowerCase();
          const exc = excludeUnit.trim().toLowerCase();
          return items.filter(({ defense }) => {
            const dset = new Set(defense.map(u=>u.toLowerCase()));
            const matchSearch = !s ? true
              : exactMatch
                ? trioKey(defense).toLowerCase() === trioKey(s.split(",").slice(0,3).map(u => u.trim().toLowerCase()))
                : s.split(",").map(t=>t.trim().toLowerCase()).filter(Boolean).every(t=> dset.has(t));
            const matchInc = !inc || dset.has(inc);
            const matchExc = !exc || !dset.has(exc);
            return matchSearch && matchInc && matchExc;
          });
        }, [defenses, searchDefense, includeUnit, excludeUnit, exactMatch]);

        const unitSet = useMemo(()=>{
          const s = new Set(UNIT_LIST);
          rows.forEach(r => [...r.defense, ...r.offense].forEach(u => u && s.add(u)));
          return Array.from(s).sort((a,b)=> a.localeCompare(b));
        }, [rows]);

        const [newEntry, setNewEntry] = useState({
          id: crypto.randomUUID(), week: "", defense:["","",""], offense:["","",""], result:"Win", notes:""
        });

        function addEntry(){
          if(!newEntry.defense.every(Boolean) || !newEntry.offense.every(Boolean)) return;
          addEntryToSheet(newEntry, setRows, setNewEntry);
        }

        function deleteEntry(id){
          alert("To delete an entry, please remove it manually in the Google Sheet."); // Google Apps Script would need extension to support deletion
        }

        return (
          <div className="container">
            <header className="row" style={{justifyContent:"space-between", alignItems:"flex-end"}}>
              <div>
                <h1>Etheria Restart – GW Counter Tracker</h1>
                <div className="muted">Records 3v3 fights & counters. Data syncs with Google Sheets for guild sharing.</div>
              </div>
              <div className="row">
                <a className="btn secondary" href="https://docs.google.com/spreadsheets/d/1I6W3XwNbC2Z8vvux82YHI8r42XC65c8dxyleYWEjOUY/edit?usp=sharing" target="_blank" rel="noopener noreferrer">Google Sheet Template</a>
              </div>
            </header>

            <div className="card" style={{padding:"16px"}}>
              <h2>Search & Filters</h2>
              <div className="grid grid-cols-12">
                <div className="col-2" style={{gridColumn:"span 4"}}>
                  <label>Defense (comma-separated)</label>
                  <input className="input" placeholder="Unit A, Unit B, Unit C" value={searchDefense} onChange={(e)=> setSearchDefense(e.target.value)}/>
                  <div className="row" style={{marginTop:8, alignItems:"center"}}>
                    <input type="checkbox" checked={exactMatch} onChange={(e)=> setExactMatch(e.target.checked)} id="exact"/>
                    <label htmlFor="exact">Exact match (full trio)</label>
                  </div>
                </div>
                <div className="col-2" style={{gridColumn:"span 4"}}>
                  <label>Include a unit</label>
                  <input className="input" list="units" placeholder="Unit name" value={includeUnit} onChange={(e)=> setIncludeUnit(e.target.value)}/>
                </div>
                <div className="col-2" style={{gridColumn:"span 4"}}>
                  <label>Exclude a unit</label>
                  <input className="input" list="units" placeholder="Unit name" value={excludeUnit} onChange={(e)=> setExcludeUnit(e.target.value)}/>
                </div>
                <datalist id="units">
                  {unitSet.map(u => <option key={u} value={u}></option>)}
                </datalist>
              </div>
            </div>

            <div style={{marginTop:12}}>
                <div className="card" style={{padding:"12px"}}>
                  <h2>Matching Defenses</h2>
                  <div className="grid" style={{gridTemplateColumns:"repeat(auto-fill, minmax(260px,1fr))"}}>
                    {filteredDefenses.map((d) => {
                      const wr = d.count ? Math.round((d.wins/d.count)*100) : 0;
                      const key = trioKey(d.defense);
                      return (
                        <div key={key} className="card" style={{padding:12}}>
                          <div className="row" style={{justifyContent:"space-between"}}>
                            <div><strong>{d.defense.join(" · ")}</strong></div>
                            <button className="btn" onClick={() => setSelectedDefenseKey(key)}>View counters</button>
                          </div>
                          <div className="muted" style={{marginTop:6}}>{d.count} fights • Overall WR {wr}%</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
                {selectedDefense && (
                  <div className="card" style={{padding:"12px", marginTop:12}}>
                    <div className="row" style={{justifyContent:"space-between"}}>
                      <h2>Counters for {selectedDefense.defense.join(" · ")}</h2>
                      <button className="btn" onClick={() => setSelectedDefenseKey(null)}>Close</button>
                    </div>
                    <div style={{marginTop:12}}>
                      {Array.from(selectedDefense.offenses.values()).map(o => {
                        const wr = o.total ? Math.round((o.wins/o.total)*100) : 0;
                        const k = trioKey(o.offense);
                        return (
                          <div key={k} className="row" style={{justifyContent:"space-between", padding:"4px 0"}}>
                            <div>{o.offense.join(" · ")}</div>
                            <div className="muted">{o.total} fights • WR {wr}%</div>
                          </div>
                        );
                      })}
                      {!selectedDefense.offenses.size && (
                        <div className="muted">No counters recorded.</div>
                      )}
                    </div>
                  </div>
                )}
              </div>

            <div className="card" style={{padding:"16px", marginTop:12}}>
              <h2>Add a fight</h2>
              <div className="grid grid-cols-12">
                <div style={{gridColumn:"span 2"}}>
                  <label>Week (optional)</label>
                  <input className="input" placeholder="S38" value={newEntry.week} onChange={(e)=> setNewEntry(n => ({...n, week: e.target.value}))}/>
                </div>
                {[0,1,2].map(i => (
                  <div key={"def-"+i} style={{gridColumn:"span 2"}}>
                    <label>Defender {i+1}</label>
                    <input className="input" list="units" placeholder="Unit" value={newEntry.defense[i]} onChange={(e)=>{
                      const v = e.target.value;
                      setNewEntry(n => ({...n, defense: [...n.defense.slice(0,i), v, ...n.defense.slice(i+1)]}));
                    }}/>
                  </div>
                ))}
                {[0,1,2].map(i => (
                  <div key={"off-"+i} style={{gridColumn:"span 2"}}>
                    <label>Attacker {i+1}</label>
                    <input className="input" list="units" placeholder="Unit" value={newEntry.offense[i]} onChange={(e)=>{
                      const v = e.target.value;
                      setNewEntry(n => ({...n, offense: [...n.offense.slice(0,i), v, ...n.offense.slice(i+1)]}));
                    }}/>
                  </div>
                ))}
                <div style={{gridColumn:"span 2"}}>
                  <label>Result</label>
                  <div className="row">
                    <button className="btn secondary" onClick={()=> setNewEntry(n => ({...n, result:"Win"}))}>Win</button>
                    <button className="btn secondary" onClick={()=> setNewEntry(n => ({...n, result:"Lose"}))}>Lose</button>
                    <span className="pill">Current: {newEntry.result}</span>
                  </div>
                </div>
                <div style={{gridColumn:"span 10"}}>
                  <label>Notes</label>
                  <input className="input" placeholder="Observations (gear, speed tuning, conditions, etc.)" value={newEntry.notes} onChange={(e)=> setNewEntry(n => ({...n, notes: e.target.value}))}/>
                </div>
                <div style={{gridColumn:"span 2", display:"flex", alignItems:"end"}}>
                  <button className="btn" onClick={addEntry}>Add</button>
                </div>
              </div>
            </div>

            <div className="card" style={{padding:"16px", marginTop:12}}>
              <h2>Fight history ({rows.length})</h2>
              <div style={{overflowX:"auto"}}>
                <table>
                  <thead>
                    <tr><th>Week</th><th>Defense</th><th>Offense</th><th>Result</th><th>Notes</th><th>Actions</th></tr>
                  </thead>
                  <tbody>
                    {rows.map(r => (
                      <tr key={r.id}>
                        <td>{r.week || "—"}</td>
                        <td>{trioKey(r.defense)}</td>
                        <td>{trioKey(r.offense)}</td>
                        <td>{r.result}</td>
                        <td>{r.notes || ""}</td>
                        <td><button className="btn" onClick={()=> deleteEntry(r.id)}>Delete</button></td>
                      </tr>
                    ))}
                    {!rows.length && (
                      <tr><td colSpan="6" className="muted">No data yet.</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App/>, document.getElementById("root"));
    </script>
  </body>
</html>
